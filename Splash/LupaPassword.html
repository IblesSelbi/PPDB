<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lupa Password - School Payment App</title>

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="../css/LupaPassword.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Background Section -->
        <div class="bg-section"></div>

        <!-- Content Section -->
        <div class="content-section">
            <div class="container h-100">
                <div class="row h-100 align-items-center justify-content-center">
                    <div class="col-md-6 col-lg-5">
                        <!-- Back Button -->
                        <div class="mb-3">
                            <a href="Login.html" class="back-btn">
                                <i class="fas fa-arrow-left"></i>
                                Kembali ke Login
                            </a>
                        </div>

                        <!-- Card Container -->
                        <div class="card card-reset shadow-lg">
                            <div class="card-body p-4 p-md-4">

                                <!-- Step 1: Email Input -->
                                <div id="step1" class="step-content">
                                    <div class="text-center mb-4">
                                        <div class="icon-wrapper mb-3">
                                            <i class="fas fa-lock fa-3x"></i>
                                        </div>
                                        <h3 class="font-weight-bold mb-2">Lupa Password?</h3>
                                        <p class="text-muted">Masukkan email Anda untuk menerima kode OTP</p>
                                    </div>

                                    <form id="emailForm">
                                        <div class="form-group mb-5">
                                            <label class="font-weight-bold small text-uppercase mb-2">Email</label>
                                            <div class="input-group input-group-lg">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-envelope"></i>
                                                    </span>
                                                </div>
                                                <input type="email" class="form-control form-control-lg" id="emailInput"
                                                    placeholder="contoh@email.com" required>
                                            </div>
                                        </div>

                                        <div id="emailError" class="alert alert-danger d-none mb-4" role="alert">
                                            <i class="fas fa-exclamation-circle mr-2"></i>
                                            <span id="emailErrorText"></span>
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-block btn-lg font-weight-bold">
                                            <i class="fas fa-paper-plane mr-2"></i>Kirim Kode OTP
                                        </button>
                                    </form>
                                </div>

                                <!-- Step 2: OTP Verification -->
                                <div id="step2" class="step-content d-none">
                                    <div class="text-center mb-4">
                                        <div class="icon-wrapper mb-3">
                                            <i class="fas fa-shield-alt fa-3x"></i>
                                        </div>
                                        <h3 class="font-weight-bold mb-2">Verifikasi OTP</h3>
                                        <p class="text-muted">Kode OTP telah dikirim ke <br><strong
                                                id="emailDisplay"></strong></p>
                                    </div>

                                    <form id="otpForm">
                                        <div class="form-group mb-3">
                                            <label class="font-weight-bold small text-uppercase mb-3">Masukkan Kode
                                                OTP</label>
                                            <div class="otp-input-group">
                                                <input type="text" class="otp-input" maxlength="1" id="otp1" required>
                                                <input type="text" class="otp-input" maxlength="1" id="otp2" required>
                                                <input type="text" class="otp-input" maxlength="1" id="otp3" required>
                                                <input type="text" class="otp-input" maxlength="1" id="otp4" required>
                                                <input type="text" class="otp-input" maxlength="1" id="otp5" required>
                                                <input type="text" class="otp-input" maxlength="1" id="otp6" required>
                                            </div>
                                        </div>

                                        <div id="otpError" class="alert alert-danger d-none mb-4" role="alert">
                                            <i class="fas fa-exclamation-circle mr-2"></i>
                                            <span id="otpErrorText"></span>
                                        </div>

                                        <div class="text-center mb-4">
                                            <p class="text-muted small mb-2">Tidak menerima kode?</p>
                                            <button type="button" class="btn btn-link p-0" id="resendBtn">
                                                Kirim Ulang Kode <span id="timer"></span>
                                            </button>
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-block btn-lg font-weight-bold">
                                            <i class="fas fa-check mr-2"></i>Verifikasi Kode
                                        </button>
                                    </form>
                                </div>

                                <!-- Step 3: New Password -->
                                <div id="step3" class="step-content d-none">
                                    <div class="text-center mb-4">
                                        <div class="icon-wrapper mb-3">
                                            <i class="fas fa-key fa-3x"></i>
                                        </div>
                                        <h3 class="font-weight-bold mb-2">Buat Password Baru</h3>
                                        <p class="text-muted">Masukkan password baru untuk akun Anda</p>
                                    </div>

                                    <form id="passwordForm">
                                        <div class="form-group mb-4">
                                            <label class="font-weight-bold small text-uppercase mb-2">Password
                                                Baru</label>
                                            <div class="input-group input-group-lg">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-lock"></i>
                                                    </span>
                                                </div>
                                                <input type="password" class="form-control form-control-lg"
                                                    id="newPassword" placeholder="password baru" required>
                                                <div class="input-group-append">
                                                    <span class="input-group-text toggle-password"
                                                        data-target="newPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="form-group mb-4">
                                            <label class="font-weight-bold small text-uppercase mb-2">Konfirmasi
                                                Password</label>
                                            <div class="input-group input-group-lg">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text">
                                                        <i class="fas fa-lock"></i>
                                                    </span>
                                                </div>
                                                <input type="password" class="form-control form-control-lg"
                                                    id="confirmPassword" placeholder="ulang password" required>
                                                <div class="input-group-append">
                                                    <span class="input-group-text toggle-password"
                                                        data-target="confirmPassword">
                                                        <i class="fas fa-eye"></i>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="password-strength mb-4">
                                            <small class="text-muted">Kekuatan Password:</small>
                                            <div class="progress" style="height: 5px;">
                                                <div class="progress-bar" id="strengthBar" role="progressbar"
                                                    style="width: 0%"></div>
                                            </div>
                                            <small id="strengthText" class="text-muted"></small>
                                        </div>

                                        <div id="passwordError" class="alert alert-danger d-none mb-4" role="alert">
                                            <i class="fas fa-exclamation-circle mr-2"></i>
                                            <span id="passwordErrorText"></span>
                                        </div>

                                        <button type="submit" class="btn btn-primary btn-block btn-lg font-weight-bold">
                                            <i class="fas fa-check-circle mr-2"></i>Reset Password
                                        </button>
                                    </form>
                                </div>

                            </div>
                        </div>

                        <p class="text-center text-muted mt-3 small">
                            ¬© 2022-2025 School Payment App. All rights reserved.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-body text-center p-5">
                    <div class="success-icon mb-4">
                        <i class="fas fa-check-circle fa-5x text-success"></i>
                    </div>
                    <h4 class="font-weight-bold mb-3">Password Berhasil Direset!</h4>
                    <p class="text-muted mb-4">Password Anda telah berhasil diubah. Silakan login dengan password baru
                        Anda.</p>
                    <a href="Login.html" class="btn btn-primary btn-lg px-5">
                        <i class="fas fa-sign-in-alt mr-2"></i>Login Sekarang
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 4 JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Custom JS -->
    <script>
        // Variables
        let userEmail = '';
        let correctOTP = '';
        let countdownTimer = null;

        // Database email terdaftar (simulasi)
        const registeredEmails = [
            'admin@gmail.com',
            'siswa@schoolpay.co.id',
            'test@gmail.com',
            'demo@schoolpay.co.id'
        ];

        // Step Navigation
        function showStep(stepNumber) {
            // Hide all steps
            document.querySelectorAll('.step-content').forEach(step => {
                step.classList.add('d-none');
            });

            // Show selected step
            document.getElementById('step' + stepNumber).classList.remove('d-none');
        }

        // ==================== STEP 1: EMAIL ====================
        document.getElementById('emailForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const emailInput = document.getElementById('emailInput');
            const emailError = document.getElementById('emailError');
            const emailErrorText = document.getElementById('emailErrorText');
            const submitBtn = this.querySelector('button[type="submit"]');

            const email = emailInput.value.trim();

            // Validasi email format
            if (!validateEmail(email)) {
                emailErrorText.textContent = 'Format email tidak valid!';
                emailError.classList.remove('d-none');
                return;
            }

            // Show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2"></span>Mengirim...';

            // Simulasi pengecekan email di database (1.5s delay)
            setTimeout(() => {
                // Cek apakah email terdaftar
                if (!registeredEmails.includes(email.toLowerCase())) {
                    emailErrorText.textContent = 'Email tidak terdaftar dalam sistem!';
                    emailError.classList.remove('d-none');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Kirim Kode OTP';
                    return;
                }

                // Generate OTP 6 digit
                correctOTP = generateOTP();
                console.log('========================================');
                console.log('üìß Email:', email);
                console.log('üîê OTP yang benar:', correctOTP);
                console.log('‚è∞ Berlaku selama 60 detik');
                console.log('========================================');

                // Simpan email
                userEmail = email;
                document.getElementById('emailDisplay').textContent = email;

                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Kirim Kode OTP';

                // Pindah ke step 2
                showStep(2);

                // Start countdown timer
                startCountdown(60);

                // Focus ke input OTP pertama
                document.getElementById('otp1').focus();

                // Show success notification
                showNotification('success', 'Kode OTP berhasil dikirim ke ' + email);
            }, 1500);
        });

        // Email validation
        function validateEmail(email) {
            const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return re.test(email);
        }

        // Generate random OTP
        function generateOTP() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Hide email error on input
        document.getElementById('emailInput').addEventListener('input', function () {
            document.getElementById('emailError').classList.add('d-none');
        });

        // ==================== STEP 2: OTP ====================
        // OTP Input Auto Focus
        const otpInputs = document.querySelectorAll('.otp-input');

        otpInputs.forEach((input, index) => {
            // Move to next input on input
            input.addEventListener('input', function () {
                if (this.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            // Move to previous input on backspace
            input.addEventListener('keydown', function (e) {
                if (e.key === 'Backspace' && this.value === '' && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });

            // Only allow numbers
            input.addEventListener('keypress', function (e) {
                if (!/[0-9]/.test(e.key)) {
                    e.preventDefault();
                }
            });

            // Hide error on input
            input.addEventListener('input', function () {
                document.getElementById('otpError').classList.add('d-none');
            });
        });

        // OTP Form Submit
        document.getElementById('otpForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const otpError = document.getElementById('otpError');
            const otpErrorText = document.getElementById('otpErrorText');
            const submitBtn = this.querySelector('button[type="submit"]');

            // Get OTP value
            let otpValue = '';
            otpInputs.forEach(input => {
                otpValue += input.value;
            });

            // Validasi OTP
            if (otpValue.length !== 6) {
                otpErrorText.textContent = 'Mohon masukkan kode OTP lengkap!';
                otpError.classList.remove('d-none');
                return;
            }

            // Show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2"></span>Memverifikasi...';

            // Simulasi verifikasi (1.5s delay - lebih realistis)
            setTimeout(() => {
                if (otpValue === correctOTP) {
                    // OTP benar, pindah ke step 3
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verifikasi Kode';

                    // Stop countdown
                    if (countdownTimer) {
                        clearInterval(countdownTimer);
                    }

                    showStep(3);
                    document.getElementById('newPassword').focus();

                    showNotification('success', 'Kode OTP berhasil diverifikasi!');
                } else {
                    // OTP salah
                    otpErrorText.textContent = 'Kode OTP salah! Silakan coba lagi. Kode yang benar: ' + correctOTP;
                    otpError.classList.remove('d-none');

                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check mr-2"></i>Verifikasi Kode';

                    // Reset OTP inputs
                    otpInputs.forEach(input => {
                        input.value = '';
                    });
                    otpInputs[0].focus();
                }
            }, 1500);
        });

        // Countdown Timer
        function startCountdown(seconds) {
            const resendBtn = document.getElementById('resendBtn');
            const timerSpan = document.getElementById('timer');
            let timeLeft = seconds;

            resendBtn.disabled = true;

            countdownTimer = setInterval(() => {
                timeLeft--;
                timerSpan.textContent = `(${timeLeft}s)`;

                if (timeLeft <= 0) {
                    clearInterval(countdownTimer);
                    resendBtn.disabled = false;
                    timerSpan.textContent = '';
                }
            }, 1000);
        }

        // Resend OTP
        document.getElementById('resendBtn').addEventListener('click', function () {
            // Generate new OTP
            correctOTP = generateOTP();
            console.log('========================================');
            console.log('üîÑ OTP baru telah dikirim!');
            console.log('üîê OTP baru:', correctOTP);
            console.log('‚è∞ Berlaku selama 60 detik');
            console.log('========================================');

            // Reset OTP inputs
            otpInputs.forEach(input => {
                input.value = '';
            });
            otpInputs[0].focus();

            // Hide error
            document.getElementById('otpError').classList.add('d-none');

            // Start new countdown
            startCountdown(60);

            // Show notification
            showNotification('info', 'Kode OTP baru telah dikirim ke ' + userEmail);
        });

        // ==================== STEP 3: NEW PASSWORD ====================
        // Toggle Password Visibility
        document.querySelectorAll('.toggle-password').forEach(toggle => {
            toggle.addEventListener('click', function () {
                const targetId = this.getAttribute('data-target');
                const targetInput = document.getElementById(targetId);
                const icon = this.querySelector('i');

                if (targetInput.type === 'password') {
                    targetInput.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    targetInput.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
            });
        });

        // Password Strength Checker
        document.getElementById('newPassword').addEventListener('input', function () {
            const password = this.value;
            const strengthBar = document.getElementById('strengthBar');
            const strengthText = document.getElementById('strengthText');

            let strength = 0;
            let feedback = '';

            if (password.length >= 8) strength += 25;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength += 25;
            if (/[0-9]/.test(password)) strength += 25;
            if (/[^A-Za-z0-9]/.test(password)) strength += 25;

            strengthBar.style.width = strength + '%';

            if (strength <= 25) {
                strengthBar.className = 'progress-bar bg-danger';
                feedback = 'Lemah';
            } else if (strength <= 50) {
                strengthBar.className = 'progress-bar bg-warning';
                feedback = 'Cukup';
            } else if (strength <= 75) {
                strengthBar.className = 'progress-bar bg-info';
                feedback = 'Bagus';
            } else {
                strengthBar.className = 'progress-bar bg-success';
                feedback = 'Kuat';
            }

            strengthText.textContent = feedback;

            // Hide error on input
            document.getElementById('passwordError').classList.add('d-none');
        });

        // Hide password error on input
        document.getElementById('confirmPassword').addEventListener('input', function () {
            document.getElementById('passwordError').classList.add('d-none');
        });

        // Password Form Submit
        document.getElementById('passwordForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const passwordError = document.getElementById('passwordError');
            const passwordErrorText = document.getElementById('passwordErrorText');
            const submitBtn = this.querySelector('button[type="submit"]');

            // Validasi password
            if (newPassword.length < 8) {
                passwordErrorText.textContent = 'Password minimal 8 karakter!';
                passwordError.classList.remove('d-none');
                return;
            }

            if (newPassword !== confirmPassword) {
                passwordErrorText.textContent = 'Password tidak cocok!';
                passwordError.classList.remove('d-none');
                return;
            }

            // Cek kekuatan password
            const strengthBar = document.getElementById('strengthBar');
            const currentStrength = parseInt(strengthBar.style.width);

            if (currentStrength < 50) {
                passwordErrorText.textContent = 'Password terlalu lemah! Gunakan kombinasi huruf besar, kecil, angka, dan simbol.';
                passwordError.classList.remove('d-none');
                return;
            }

            // Show loading
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm mr-2"></span>Memproses...';

            // Simulasi reset password (2s delay - lebih realistis)
            setTimeout(() => {
                // Success! Show modal
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i>Reset Password';

                console.log('========================================');
                console.log('‚úÖ Password berhasil direset!');
                console.log('üìß Email:', userEmail);
                console.log('üîí Password baru:', newPassword);
                console.log('========================================');

                $('#successModal').modal('show');

                // Auto redirect after 3 seconds
                setTimeout(() => {
                    window.location.href = 'Login.html';
                }, 3000);
            }, 2000);
        });

        // Prevent modal close
        $('#successModal').modal({
            show: false,
            backdrop: 'static',
            keyboard: false
        });


        // ==================== NOTIFICATION SYSTEM ====================
        function showNotification(type, message) {
            // Buat toast notification (simple alert untuk demo)
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';

            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} position-fixed`;
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
            notification.innerHTML = `<i class="fas ${icon} mr-2"></i>${message}`;

            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    notification.remove();
                }, 500);
            }, 3000);
        }
    </script>
</body>

</html>